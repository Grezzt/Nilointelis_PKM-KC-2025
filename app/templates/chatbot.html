{% extends "layout_dashboard.html" %}

{% block styles %}
<link rel="stylesheet" href="../static/css/chatbot.css">
{% endblock %}

{% block sidebar_chatbot %}
class="active"
{% endblock %}

{% block content %}
<h4 class="title title2">Chatbot</h4>
<div class="chat-container">

    <div class="chat-messages" id="chat-messages">
        <!-- pesan sample, nanti tambah dynamic disini-->
        <div class="message-group bot-group">
            <div class="message bot-message">
                <span class="message-text" style="font-size: 1.1rem; font-weight: 550">Hai! Aku NiloBot, ada yang bisa aku bantu?</span>
                <!-- <span class="message-time">00:00</span> -->
            </div>
        </div>
        {% for msg in messages %}
            {% if msg.role == "user" %}
                <div class="message-group user-group">
                    <div class="message user-message">
                        <span class="message-text">{{ msg.content|safe }}</span>
                        <span class="message-time">{{ msg.time }}</span>
                    </div>
                </div>
            {% elif msg.role == "assistant" %}
                <div class="message-group bot-group">
                    <div class="message bot-message">
                        <span class="message-text">{{ msg.content|safe }}</span>
                        <span class="message-time">{{ msg.time }}</span>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    <!-- input form chat -->
    <form id="chat-form" class="chat-input-container">
        <div class="chat-input-area">
            <textarea id="user-input" name="user-input" placeholder="Tanyakan Sesuatu ?" rows="1"></textarea>
            <button id="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#FFA630" fill-rule="evenodd" d="M3.291 3.309a.75.75 0 0 0-.976.996l3.093 6.945H13a.75.75 0 0 1 0 1.5H5.408l-3.093 6.945a.75.75 0 0 0 .976.996l19-8a.75.75 0 0 0 0-1.382z" clip-rule="evenodd"/></svg>
            </button>
        </div>
        <div class="disclaimer">
            <span>Respons AI dapat mengandung kekeliruan. Mohon diperiksa ulang</span>
        </div>
    </form>
</div>

<script>
const chatMessages = document.getElementById("chat-messages");
const chatForm = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const sendButton = document.getElementById("send-button");

// scroll helper
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// auto resize
function autoResize() {
    userInput.style.height = 'auto';
    const newHeight = Math.min(userInput.scrollHeight, 200);
    userInput.style.height = newHeight + 'px';
}
userInput.addEventListener('input', autoResize);

// buat pesan
function addMessage(content, isUser = false) {
    const messageGroup = document.createElement("div");
    messageGroup.className = `message-group ${isUser ? "user-group" : "bot-group"} fade-in`;

    const message = document.createElement("div");
    message.className = `message ${isUser ? "user-message" : "bot-message"}`;

    const text = document.createElement("span");
    text.className = "message-text";
    text.innerHTML = content;

    const time = document.createElement("span");
    time.className = "message-time";
    time.textContent = new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

    message.appendChild(text);
    message.appendChild(time);
    messageGroup.appendChild(message);
    chatMessages.appendChild(messageGroup);

    autoResize()
    scrollToBottom();
}

// typing indicator
function showTyping() {
    const typing = document.createElement("div");
    typing.className = "message-group bot-group fade-in";
    typing.id = "typing-indicator";
    typing.innerHTML = `
        <div class="typing-indicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    chatMessages.appendChild(typing);
    scrollToBottom();
    autoResize()
}

function hideTyping() {
    const typing = document.getElementById("typing-indicator");
    if (typing) typing.remove();
}

// disable/enable input
function disableInput() {
    userInput.disabled = true;
    sendButton.disabled = true;
}

function enableInput() {
    userInput.disabled = false;
    sendButton.disabled = false;
    userInput.focus();
}

// handle submit
async function handleSubmit(e) {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    // tampilkan pesan user
    addMessage(message, true);

    // clear input + disable
    userInput.value = "";
    disableInput();

    // fake typing
    showTyping();

    try {
        const response = await fetch('{{ url_for("chatbot.chatbot") }}', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
        });
        const data = await response.json();

        hideTyping();
        if (data.status === "success") {
            addMessage(data.response);
        } else {
            addMessage("⚠️ Terjadi kesalahan: " + (data.message || "Tidak diketahui"));
        }
    } catch (err) {
        console.error("Error:", err);
        hideTyping();
        addMessage("⚠️ Gagal komunikasi dengan server");
    } finally {
        enableInput();
    }
}

// Enter untuk submit
userInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSubmit(e);
    }
});

// kirim form
chatForm.addEventListener("submit", handleSubmit);

// auto scroll saat load
scrollToBottom();

// auto resize userInput
autoResize()
</script>
{% endblock %}