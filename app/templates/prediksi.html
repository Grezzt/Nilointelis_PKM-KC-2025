{% extends "layout_dashboard.html" %}

{% block styles %}
<link rel="stylesheet" href="../static/css/dashboard.css">
<link rel="stylesheet" href="../static/css/prediksi.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* Loading Spinner */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.7);
    z-index: 1000;
    text-align: center;
}
.spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #2EC4B6;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Chart Layout */
.charts-section {
    margin-top: 2rem;
}
.chart-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
}
.chart-container {
    flex: 1 1 45%;
    min-width: 280px;
    background: #fff;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.chart-container h5 {
    margin-bottom: 0.5rem;
    text-align: center;
}
.alert {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    text-align: center;
}
.alert.success { background: #d4edda; color: #155724; }
.alert.error { background: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block sidebar_prediksi %}
class="active"
{% endblock %}

{% block content %}
<div class="container">
    <button id="btnPrediksi" class="btn-ai">üîÆ Jalankan Prediksi</button>

    <!-- Loading animation -->
    <div id="loadingBox" class="loading-spinner" style="display:none;">
        <div class="spinner"></div>
        <p>Menjalankan prediksi...</p>
    </div>

    <!-- Success & error messages -->
    <div id="successBox" class="alert success" style="display:none;">‚úÖ Prediksi berhasil!</div>
    <div id="errorBox" class="alert error" style="display:none;"></div>

    <!-- Chart Section -->
    <div class="charts-section">
        <div class="chart-row">
            <div class="chart-container"><h5>pH</h5><canvas id="chartPh"></canvas></div>
            <div class="chart-container"><h5>Suhu</h5><canvas id="chartSuhu"></canvas></div>
        </div>
        <div class="chart-row">
            <div class="chart-container"><h5>Turbidity</h5><canvas id="chartTurbidity"></canvas></div>
            <div class="chart-container"><h5>TDS</h5><canvas id="chartTds"></canvas></div>
        </div>
    </div>
</div>

<script>
let charts = {}; // simpan semua chart instance

document.getElementById("btnPrediksi").addEventListener("click", async () => {
    // Reset tampilan
    document.getElementById("successBox").style.display = "none";
    document.getElementById("errorBox").style.display = "none";
    document.getElementById("loadingBox").style.display = "flex";

    try {
        let res = await fetch("/run_prediksi", { method: "POST" });
        let json = await res.json();

        document.getElementById("loadingBox").style.display = "none";

        if (json.status === "error") {
            document.getElementById("errorBox").innerText = "‚ùå " + json.message;
            document.getElementById("errorBox").style.display = "block";
            return;
        }

        const labels = json.data.timestamps;
        renderChart("chartPh", labels, json.data.ph, "pH");
        renderChart("chartSuhu", labels, json.data.suhu, "Suhu");
        renderChart("chartTurbidity", labels, json.data.turbidity, "Turbidity");
        renderChart("chartTds", labels, json.data.tds, "TDS");

        document.getElementById("successBox").style.display = "block";
    } catch (err) {
        document.getElementById("loadingBox").style.display = "none";
        document.getElementById("errorBox").innerText = "‚ùå Gagal melakukan prediksi: " + err;
        document.getElementById("errorBox").style.display = "block";
    }
});

function renderChart(canvasId, labels, data, label) {
    // Hapus chart lama dulu kalau ada
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    const ctx = document.getElementById(canvasId).getContext("2d");
    charts[canvasId] = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                borderColor: "#2EC4B6",
                backgroundColor: "rgba(46, 196, 182, 0.2)",
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
                y: { beginAtZero: false }
            }
        }
    });
}
</script>
{% endblock %}
