{% extends "layout_dashboard.html" %}

{% block styles %}
<link rel="stylesheet" href="../static/css/dashboard.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
{% endblock %}

<!-- dumb ways but its works xixixi -->
{% block sidebar_dasboard %}
class ="active"
{% endblock %}

{% block content %}
<h4 class="title title2">Dashboard</h4>

<div class="sensor-container">
    <div class="boxes">
    <!-- PH -->
    <div class="box">
        <span class="text-box">pH Air</span>
        <div class="value-row">
            <span id="ph_value">N/A</span>
            <img class="imgLogo" src="../static/assets/Vector ph.svg" alt="PH air">
        </div>
    </div>

    <!-- Suhu -->
    <div class="box">
        <span class="text-box">Suhu Air</span>
        <div class="value-row">
            <span id="suhu_value">N/A</span>
            <img class="imgLogo" src="../static/assets/vector suhu.svg" alt="Suhu air">
        </div>
    </div>

    <!-- TDS -->
    <div class="box">
        <span class="text-box">TDS</span>
        <div class="value-row">
            <span id="tds_value">N/A</span>
            <img class="imgLogo" src="../static/assets/Vector TDS.svg" alt="TDS">
        </div>
    </div>

    <!-- Turbidity -->
    <div class="box">
        <span class="text-box">Turbidity</span>
        <div class="value-row">
            <span id="turbidity_value">N/A</span>
            <img class="imgLogo" src="../static/assets/Vector turbidity.svg" alt="Turbidity">
        </div>
    </div>
</div>


<!-- <h4 class="title title2">Dashboard</h4>
<div class="container">
    <div class="boxes">
        <div class="box box_1">
            <span class="text">PH Air</span>
            <span class="number">
                <span id="ph_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector ph.svg" alt="PH air">
            </span>
        </div>
        <div class="box box_2">
            <span class="text">Suhu Air</span>
            <span class="number">
                <span id="suhu_value">N/A</span>
                <img class="imgLogo" src="../static/assets/vector suhu.svg" alt="">
            </span>
        </div>
        <div class="box box_3">
            <span class="text">TDS</span>
            <span class="number">
                <span id="tds_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector TDS.svg" alt="">
            </span>
        </div>
        <div class="box box_4">
            <span class="text">Turbidity</span>
            <span class="number">
                <span id="turbidity_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector turbidity.svg" alt="">
            </span>
        </div>
    </div> -->

    <!-- Button Dapatkan Saran -->
    <div class="col-md-4">
        <button class="btn btn-light fw-bold w-100 mt-4 boxSaran" onclick="getAIRecommendation()">
            <svg class="bintang_saran" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 29" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><g fill="none"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="#2EC4B6" d="M9.107 5.448c.598-1.75 3.016-1.803 3.725-.159l.06.16l.807 2.36a4 4 0 0 0 2.276 2.411l.217.081l2.36.806c1.75.598 1.803 3.016.16 3.725l-.16.06l-2.36.807a4 4 0 0 0-2.412 2.276l-.081.216l-.806 2.361c-.598 1.75-3.016 1.803-3.724.16l-.062-.16l-.806-2.36a4 4 0 0 0-2.276-2.412l-.216-.081l-2.36-.806c-1.751-.598-1.804-3.016-.16-3.724l.16-.062l2.36-.806A4 4 0 0 0 8.22 8.025l.081-.216zM19 2a1 1 0 0 1 .898.56l.048.117l.35 1.026l1.027.35a1 1 0 0 1 .118 1.845l-.118.048l-1.026.35l-.35 1.027a1 1 0 0 1-1.845.117l-.048-.117l-.35-1.026l-1.027-.35a1 1 0 0 1-.118-1.845l.118-.048l1.026-.35l.35-1.027A1 1 0 0 1 19 2"/></g></svg>
            Dapatkan Saran
        </button>
    </div>

    <!-- Modal AI Recommendation -->
    <div class="modal fade" id="aiRecModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-weight:700">Saran dari AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="aiRecLoading" class="text-center d-none">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Mohon Tunggu Sebentar, AI sedang berpikir...</p>
                    </div>
                    <div id="aiRecContent"
                        style="max-height:500px; overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word; text-align:left; display:flex; flex-direction: column; gap: 1rem; font-size: 1.1rem; line-height: 1.6;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->

    <!-- Filter Tanggal -->
    <div class="filter-controls">
        <form class="filter-controls" id="filterForm" method="POST" action="/dashboard/filter">
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input type="text" id="tanggalAwal" name="tanggal_awal" placeholder="Tanggal Awal" class="btn btn-filter">
            </div>
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input type="text" id="tanggalAkhir" name="tanggal_akhir" placeholder="Tanggal Akhir" class="btn btn-filter">
            </div>
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input id="granulitas" name="granulitas" type="text" class="btn btn-filter" placeholder="Granulitas" readonly>
            </div>
        </form>
    </div>

    <!-- Ringkasan Statistik -->
    <div class="statistics-table">
        <h4>Ringkasan Statistik</h4>
        <table class="table table-isi">
            <thead>
                <tr>
                    <th>Sensor</th>
                    <th>Maksimum</th>
                    <th>Minimum</th>
                    <th>Rata-Rata</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>PH</td>
                    <!-- sementara, ntar ganti pake data dynamic -->
                    <td id="phMax">-</td>
                    <td id="phMin">-</td>
                    <td id="phAvg">-</td>
                </tr>
                <tr>
                    <td>Suhu</td>
                    <td id="suhuMax">-</td>
                    <td id="suhuMin">-</td>
                    <td id="suhuAvg">-</td>
                </tr>
                <tr>
                    <td>TDS</td>
                    <td id="tdsMax">-</td>
                    <td id="tdsMin">-</td>
                    <td id="tdsAvg">-</td>
                </tr>
                <tr>
                    <td>Turbidity</td>
                    <td id="turbidityMax">-</td>
                    <td id="turbidityMin">-</td>
                    <td id="turbidityAvg">-</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Charts Section -->
    <div class="charts-section statistics-table">
        <div class="chart-row">
            <div class="chart-container">
                <h5>Grafik PH</h5>
                <canvas id="phChart"></canvas>
            </div>
            <div class="chart-container">
                <h5>Grafik Suhu</h5>
                <canvas id="suhuChart"></canvas>
            </div>
        </div>
        <div class="chart-row">
            <div class="chart-container">
                <h5>Grafik TDS</h5>
                <canvas id="tdsChart"></canvas>
            </div>
            <div class="chart-container">
                <h5>Grafik Turbidity</h5>
                <canvas id="turbidityChart"></canvas>
            </div>
        </div>

        <!-- Analisis AI Button -->
        <div class="ai-analysis">
            <button class="btn btn-ai" onclick="getAIAnalysis()">
                <svg class="svg-bintang" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><g fill="none"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="#FFA630" d="M9.107 5.448c.598-1.75 3.016-1.803 3.725-.159l.06.16l.807 2.36a4 4 0 0 0 2.276 2.411l.217.081l2.36.806c1.75.598 1.803 3.016.16 3.725l-.16.06l-2.36.807a4 4 0 0 0-2.412 2.276l-.081.216l-.806 2.361c-.598 1.75-3.016 1.803-3.724.16l-.062-.16l-.806-2.36a4 4 0 0 0-2.276-2.412l-.216-.081l-2.36-.806c-1.751-.598-1.804-3.016-.16-3.724l.16-.062l2.36-.806A4 4 0 0 0 8.22 8.025l.081-.216zM19 2a1 1 0 0 1 .898.56l.048.117l.35 1.026l1.027.35a1 1 0 0 1 .118 1.845l-.118.048l-1.026.35l-.35 1.027a1 1 0 0 1-1.845.117l-.048-.117l-.35-1.026l-1.027-.35a1 1 0 0 1-.118-1.845l.118-.048l1.026-.35l.35-1.027A1 1 0 0 1 19 2"/></g></svg>
                Analisis AI
            </button>
        </div>

        <!-- Modal AI Analyst -->
        <div class="modal fade" id="aiAnalysisModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" style="font-weight:700">Analisis Grafik</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="aiAnalysisLoading" class="text-center d-none">
                            <div class="spinner-border text-warning" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">AI sedang menganalisis data Anda...</p>
                        </div>
                        <div id="aiAnalysisContent"
                            style="max-height:500px; overflow-y:auto; overflow-x:hidden; word-wrap:break-word; text-align:left; display:flex; flex-direction: column; gap: 0.2rem; font-size: 1.1rem; line-height: 1.4;">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Error -->
        <div class="modal fade" id="errorModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger" style="font-weight:700">
                            <i class="fas fa-exclamation-triangle me-2"></i>Perhatian
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning" role="alert">
                            <strong>Walah!</strong>
                            <p id="errorMessage" class="mb-0 mt-2"></p>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Tip: Gunakan filter tanggal untuk memilih periode data yang ingin dianalisis.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Mengerti</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<!-- cdn web socket -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="../static/js/dashboard_socket.js"></script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Dashboard Chart Script -->
<script src="../static/js/dashboard_chart_AI.js"></script>
{% endblock %}