{% extends "layout_dashboard.html" %}

{% block styles %}
<link rel="stylesheet" href="../static/css/dashboard.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
{% endblock %}

<!-- dumb ways but its works xixixi -->
{% block sidebar_dasboard %}
class ="active"
{% endblock %}

{% block content %}

<h4 class="title title2">Dashboard</h4>

<div class="sensor-container">
    <div class="boxes">
    <!-- PH -->
    <div class="box">
        <span class="text-box">PH Air</span>
        <div class="value-row">
            <span id="ph_value">17.99</span>
            <img class="imgLogo" src="../static/assets/Vector ph.svg" alt="PH air">
        </div>
    </div>

    <!-- Suhu -->
    <div class="box">
        <span class="text-box">Suhu Air</span>
        <div class="value-row">
            <span id="suhu_value">-127.0</span>
            <img class="imgLogo" src="../static/assets/vector suhu.svg" alt="Suhu air">
        </div>
    </div>

    <!-- TDS -->
    <div class="box">
        <span class="text-box">TDS</span>
        <div class="value-row">
            <span id="tds_value">N/A</span>
            <img class="imgLogo" src="../static/assets/Vector TDS.svg" alt="TDS">
        </div>
    </div>

    <!-- Turbidity -->
    <div class="box">
        <span class="text-box">Turbidity</span>
        <div class="value-row">
            <span id="turbidity_value">1941.14</span>
            <img class="imgLogo" src="../static/assets/Vector turbidity.svg" alt="Turbidity">
        </div>
    </div>
</div>


<!-- <h4 class="title title2">Dashboard</h4>
<div class="container">
    <div class="boxes">
        <div class="box box_1">
            <span class="text">PH Air</span>
            <span class="number">
                <span id="ph_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector ph.svg" alt="PH air">
            </span>
        </div>
        <div class="box box_2">
            <span class="text">Suhu Air</span>
            <span class="number">
                <span id="suhu_value">N/A</span>
                <img class="imgLogo" src="../static/assets/vector suhu.svg" alt="">
            </span>
        </div>
        <div class="box box_3">
            <span class="text">TDS</span>
            <span class="number">
                <span id="tds_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector TDS.svg" alt="">
            </span>
        </div>
        <div class="box box_4">
            <span class="text">Turbidity</span>
            <span class="number">
                <span id="turbidity_value">N/A</span>
                <img class="imgLogo" src="../static/assets/Vector turbidity.svg" alt="">
            </span>
        </div>
    </div> -->

    <!-- Button Dapatkan Saran -->
    <div class="col-md-4">
        <button class="btn btn-light fw-bold w-100 mt-4 boxSaran" onclick="getAIRecommendation()">
            <svg class="bintang_saran" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 29 29" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><g fill="none"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="#2EC4B6" d="M9.107 5.448c.598-1.75 3.016-1.803 3.725-.159l.06.16l.807 2.36a4 4 0 0 0 2.276 2.411l.217.081l2.36.806c1.75.598 1.803 3.016.16 3.725l-.16.06l-2.36.807a4 4 0 0 0-2.412 2.276l-.081.216l-.806 2.361c-.598 1.75-3.016 1.803-3.724.16l-.062-.16l-.806-2.36a4 4 0 0 0-2.276-2.412l-.216-.081l-2.36-.806c-1.751-.598-1.804-3.016-.16-3.724l.16-.062l2.36-.806A4 4 0 0 0 8.22 8.025l.081-.216zM19 2a1 1 0 0 1 .898.56l.048.117l.35 1.026l1.027.35a1 1 0 0 1 .118 1.845l-.118.048l-1.026.35l-.35 1.027a1 1 0 0 1-1.845.117l-.048-.117l-.35-1.026l-1.027-.35a1 1 0 0 1-.118-1.845l.118-.048l1.026-.35l.35-1.027A1 1 0 0 1 19 2"/></g></svg>
            Dapatkan Saran
        </button>
    </div>

    <!-- Modal AI Recommendation -->
    <div class="modal fade" id="aiRecModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-weight:700">Saran dari AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="aiRecLoading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Mohon Tunggu Sebentar, AI sedang berpikir...</p>
                    </div>
                    <div id="aiRecContent"
                        style="max-height:500px; overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word; text-align:left; display:flex; flex-direction: column; gap: 1rem; font-size: 1.1rem; line-height: 1.6;">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->

    <!-- Filter Tanggal -->
    <div class="filter-controls">
        <form class="filter-controls" id="filterForm" method="POST" action="/dashboard/filter">
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input type="text" id="tanggalAwal" name="tanggal_awal" placeholder="Tanggal Awal" class="btn btn-filter">
            </div>
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input type="text" id="tanggalAkhir" name="tanggal_akhir" placeholder="Tanggal Akhir" class="btn btn-filter">
            </div>
            <div class="input-container">
                <svg class="dropdown-filter-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><path fill="#2EC4B6" d="M19.778 12a7.778 7.778 0 1 0-15.556 0a7.778 7.778 0 0 0 15.556 0m-5.23-2.452a1.11 1.11 0 1 1 1.57 1.57l-3.332 3.334a1.11 1.11 0 0 1-1.572 0L7.881 11.12l-.076-.085a1.11 1.11 0 0 1 1.563-1.562l.084.076L12 12.095zM22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10"/></svg>
                <input id="granulitas" name="granulitas" type="text" class="btn btn-filter" placeholder="Granulitas" readonly>
            </div>
        </form>
    </div>

    <!-- Ringkasan Statistik -->
    <div class="statistics-table">
        <h4>Ringkasan Statistik</h4>
        <table class="table table-isi">
            <thead>
                <tr>
                    <th>Sensor</th>
                    <th>Maksimum</th>
                    <th>Minimum</th>
                    <th>Rata-Rata</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>PH</td>
                    <!-- sementara, ntar ganti pake data dynamic -->
                    <td id="phMax">-</td>
                    <td id="phMin">-</td>
                    <td id="phAvg">-</td>
                </tr>
                <tr>
                    <td>Suhu</td>
                    <td id="suhuMax">-</td>
                    <td id="suhuMin">-</td>
                    <td id="suhuAvg">-</td>
                </tr>
                <tr>
                    <td>TDS</td>
                    <td id="tdsMax">-</td>
                    <td id="tdsMin">-</td>
                    <td id="tdsAvg">-</td>
                </tr>
                <tr>
                    <td>Turbidity</td>
                    <td id="turbidityMax">-</td>
                    <td id="turbidityMin">-</td>
                    <td id="turbidityAvg">-</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Charts Section -->
    <div class="charts-section statistics-table">
        <div class="chart-row">
            <div class="chart-container">
                <h5>Grafik PH</h5>
                <canvas id="phChart"></canvas>
            </div>
            <div class="chart-container">
                <h5>Grafik Suhu</h5>
                <canvas id="suhuChart"></canvas>
            </div>
        </div>
        <div class="chart-row">
            <div class="chart-container">
                <h5>Grafik TDS</h5>
                <canvas id="tdsChart"></canvas>
            </div>
            <div class="chart-container">
                <h5>Grafik Turbidity</h5>
                <canvas id="turbidityChart"></canvas>
            </div>
        </div>

        <!-- Analisis AI Button -->
        <div class="ai-analysis">

            <button class="btn btn-ai"><svg class="svg-bintang" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" style="width: 1.5em; height: 1.5em; max-width: 100%; max-height: 100%; vertical-align: middle;"><g fill="none"><path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z"/><path fill="#FFA630" d="M9.107 5.448c.598-1.75 3.016-1.803 3.725-.159l.06.16l.807 2.36a4 4 0 0 0 2.276 2.411l.217.081l2.36.806c1.75.598 1.803 3.016.16 3.725l-.16.06l-2.36.807a4 4 0 0 0-2.412 2.276l-.081.216l-.806 2.361c-.598 1.75-3.016 1.803-3.724.16l-.062-.16l-.806-2.36a4 4 0 0 0-2.276-2.412l-.216-.081l-2.36-.806c-1.751-.598-1.804-3.016-.16-3.724l.16-.062l2.36-.806A4 4 0 0 0 8.22 8.025l.081-.216zM19 2a1 1 0 0 1 .898.56l.048.117l.35 1.026l1.027.35a1 1 0 0 1 .118 1.845l-.118.048l-1.026.35l-.35 1.027a1 1 0 0 1-1.845.117l-.048-.117l-.35-1.026l-1.027-.35a1 1 0 0 1-.118-1.845l.118-.048l1.026-.35l.35-1.027A1 1 0 0 1 19 2"/></g></svg>
                Analisis AI</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<!-- cdn web socket -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    let socket;

    // inisiasi socket
    function initializeSocket(){
        socket = io('/dashboard');
        socket.on('connect', function(){
            console.log('dashboard konek socket cuy');
        })
        socket.on('disconnect', function(){
            console.log('walawe dashboard ga konek socket ');
        })
        socket.on('sensor_update', function(res){
            if (res.type === 'realtime' && res.data) {
                updateRealtimeData(res.data);
            }
        })

    }

    // update realtime data
    function updateRealtimeData(data) {
        document.getElementById('ph_value').textContent = data.ph ? data.ph.toFixed(2) : 'N/A';
        document.getElementById('suhu_value').textContent = data.suhu ? data.suhu.toFixed(1) : 'N/A';
        document.getElementById('tds_value').textContent = data.tds ? data.tds.toFixed(0) : 'N/A';
        document.getElementById('turbidity_value').textContent = data.turbidity ? data.turbidity.toFixed(2) : 'N/A';

    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeSocket(); // Initialize socket di web page
    });
</script>


<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const phMax = document.getElementById('phMax');
    const phMin = document.getElementById('phMin');
    const phAvg = document.getElementById('phAvg');
    const suhuMax = document.getElementById('suhuMax');
    const suhuMin = document.getElementById('suhuMin');
    const suhuAvg = document.getElementById('suhuAvg');
    const tdsMax = document.getElementById('tdsMax');
    const tdsMin = document.getElementById('tdsMin');
    const tdsAvg = document.getElementById('tdsAvg');
    const turbidityMax = document.getElementById('turbidityMax');
    const turbidityMin = document.getElementById('turbidityMin');
    const turbidityAvg = document.getElementById('turbidityAvg');


    flatpickr("#tanggalAwal", {
        dateFormat: "d/m/Y",
    });
    flatpickr("#tanggalAkhir", {
        dateFormat: "d/m/Y",
    });
    const granulitas = document.getElementById('granulitas');
    const opsi = ['1 menit','5 menit','10 menit', '30 menit', '1 jam', '6 jam', '12 jam', 'hari', 'minggu', 'bulan'];

    const dropdownContent = document.createElement('div');
    dropdownContent.style.display = 'flex';
    dropdownContent.style.flexDirection = 'column';
    // dropdownContent.style.color = 'var(--hitam)';
    // dropdownContent.style.backgroundColor = 'var(--primary)';

    opsi.forEach(option => {
        const item = document.createElement('div');
        item.textContent = option;
        item.style.padding = '1rem 0rem';
        item.style.width = '13rem';
        item.style.cursor = 'pointer';
        item.addEventListener('click', () => {
            granulitas.value = option;
            instance.hide();
            submitForm(); // submit form waktu opsi dipilih
        });
        dropdownContent.appendChild(item);
    });

    const instance = tippy(granulitas, {
        content: dropdownContent,
        trigger: 'click',
        interactive: true,
        placement: 'bottom-start',
        arrow: false,
        theme: 'light',
    });

    // jawaban rekomendasi AI
    function getAIRecommendation() {
        const modal = new bootstrap.Modal(document.getElementById('aiRecModal'));
        modal.show();

        // tampilkan spinner, kosongkan konten lama
        document.getElementById('aiRecLoading').classList.remove('d-none');
        document.getElementById('aiRecContent').innerHTML = '';

        fetch('/dashboard/get-ai-recommendation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('aiRecLoading').classList.add('d-none');
            if (data.status === 'success') {
                document.getElementById('aiRecContent').innerHTML = data.recommendation;
            } else {
                document.getElementById('aiRecContent').innerHTML =
                    `<div class="alert alert-danger">Gagal: ${data.message}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('aiRecLoading').classList.add('d-none');
            document.getElementById('aiRecContent').innerHTML =
                `<div class="alert alert-danger">Error: ${error}</div>`;
        });
    }

    function submitForm() {
    // document.getElementById('filterForm').submit();

    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    fetch ('/dashboard/filter', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log(data.data);
            updateStatistiktabel(data.data);
            updateCharts(data.data);
        } else {
            // alert('Tidak ada data ditemukan');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan');
    });
}

function updateStatistiktabel(data){
    const stats = hitungStatistik(data);

    // Update PH statistics
    document.getElementById('phMax').textContent = stats.ph.max;
    document.getElementById('phMin').textContent = stats.ph.min;
    document.getElementById('phAvg').textContent = stats.ph.avg;

    // Update Suhu statistics
    document.getElementById('suhuMax').textContent = stats.suhu.max;
    document.getElementById('suhuMin').textContent = stats.suhu.min;
    document.getElementById('suhuAvg').textContent = stats.suhu.avg;

    // Update TDS statistics
    document.getElementById('tdsMax').textContent = stats.tds.max;
    document.getElementById('tdsMin').textContent = stats.tds.min;
    document.getElementById('tdsAvg').textContent = stats.tds.avg;

    // Update Turbidity statistics
    document.getElementById('turbidityMax').textContent = stats.turbidity.max;
    document.getElementById('turbidityMin').textContent = stats.turbidity.min;
    document.getElementById('turbidityAvg').textContent = stats.turbidity.avg;
}

function hitungStatistik(data){
    if (!data || data.length === 0) {
        return {
            ph: { min: 0, max: 0, avg: 0 },
            suhu: { min: 0, max: 0, avg: 0 },
            tds: { min: 0, max: 0, avg: 0 },
            turbidity: { min: 0, max: 0, avg: 0 }
        };
    }

    // ambil nilai data per jenis nya
    const phValues = data.map(item => item.ph).filter(val => val !== null && val !== undefined);
    const suhuValues = data.map(item => item.suhu).filter(val => val !== null && val !== undefined);
    const tdsValues = data.map(item => item.tds).filter(val => val !== null && val !== undefined);
    const turbidityValues = data.map(item => item.turbidity).filter(val => val !== null && val !== undefined);

    // Helper function to calculate min, max, avg
    function getStats(values) {
        if (values.length === 0) return { min: 0, max: 0, avg: 0 };

        const min = Math.min(...values);
        const max = Math.max(...values);
        const avg = values.reduce((sum, val) => sum + val, 0) / values.length;

        return {
            min: parseFloat(min.toFixed(2)),
            max: parseFloat(max.toFixed(2)),
            avg: parseFloat(avg.toFixed(2))
        };
    }

    return {
        ph: getStats(phValues),
        suhu: getStats(suhuValues),
        tds: getStats(tdsValues),
        turbidity: getStats(turbidityValues)
    };
}

// chart dashboard sections
let phChart, suhuChart, tdsChart, turbidityChart;
const chartConfig = {
    type: "line",
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                enabled: true,
                mode: 'index',
                intersect: false,
            }
        },

        scales: {
        x: {
            display: false,
            title: { display: true, text: "Tanggal/Waktu" }
        },
    },
    },
};

// inisiasi chart
document.addEventListener('DOMContentLoaded', function() {
    const phCtx = document.getElementById('phChart').getContext('2d');
    const suhuCtx = document.getElementById('suhuChart').getContext('2d');
    const tdsCtx = document.getElementById('tdsChart').getContext('2d');
    const turbidityCtx = document.getElementById('turbidityChart').getContext('2d');

    phChart = new Chart(phCtx, {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'PH',
                data: [],
                borderColor: '#2EC4B6',
                backgroundColor: '#CBF3F0',
                tension: 0.3,
                fill: true,
                pointRadius: 2,
            }]
        }
    });

    suhuChart = new Chart(suhuCtx, {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'Suhu',
                data: [],
                borderColor: '#FFA630',
                backgroundColor: ' #FECD8D',
                tension: 0.3,
                fill: true,
                pointRadius: 2,
            }]
        }
    });

    tdsChart = new Chart(tdsCtx, {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'TDS',
                data: [],
                borderColor: '#2EC4B6',
                backgroundColor: '#CBF3F0',
                tension: 0.3,
                fill: true,
                pointRadius: 2,
            }]
        }
    });

    turbidityChart = new Chart(turbidityCtx, {
        ...chartConfig,
        data: {
            labels: [],
            datasets: [{
                label: 'Turbidity',
                data: [],
                borderColor: '#FFA630',
                backgroundColor: ' #FECD8D',
                tension: 0.3,
                fill: true,
                pointRadius: 2,
            }]
        }
    });
});

function updateCharts(data){
    if (!data || data.length === 0) return;

        const labels = data.map(item => {
            if (item.timestamp) {
                const date = new Date(item.timestamp);
                return date.toLocaleString('id-ID', {
                    day: '2-digit', month: '2-digit', year: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });
            } else if (item.tanggal) {
                return item.tanggal;
            } else {
                return '';
            }
        });

        // Ambil data sensor
        const phData = data.map(item => item.ph);
        const suhuData = data.map(item => item.suhu);
        const tdsData = data.map(item => item.tds);
        const turbidityData = data.map(item => item.turbidity);

        phChart.data.labels = labels;
        phChart.data.datasets[0].data = phData;
        phChart.update();

        suhuChart.data.labels = labels;
        suhuChart.data.datasets[0].data = suhuData;
        suhuChart.update();

        tdsChart.data.labels = labels;
        tdsChart.data.datasets[0].data = tdsData;
        tdsChart.update();

        // Update Turbidity Chart
        turbidityChart.data.labels = labels;
        turbidityChart.data.datasets[0].data = turbidityData;
        turbidityChart.update();
}
</script>




{% endblock %}